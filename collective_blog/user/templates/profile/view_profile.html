{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans trimmed with username=user|capfirst %}{{ username }}'s profile{% endblocktrans %}{% endblock %}


{% block content %}
    <div class="primary container">
        <h1>
            {{ user|capfirst }}
            <small>{% if self_profile %}{% trans "your profile" %}{% else %}{% trans "user profile" %}{% endif %}</small>
        </h1>

        <span style="font-size: 1.1em">
            <span class="badge-group">
                <span class="{{ karma_color }} badge karma-color">{% trans "Karma" %}</span><span class="{{ karma_color }} badge outline karma-color" id="karma-score">{{ karma.score }}</span>
            </span>
            &nbsp;
            <span class="gray badge {% if self_vote.vote != 1 %}outline{% endif %}" id="karma-upvote-button"><span class="arrow-up center icon"></span></span>
            <span class="gray badge {% if self_vote.vote != -1 %}outline{% endif %}" id="karma-downvote-button"><span class="arrow-down center icon"></span></span>
            &nbsp;
            <span id="karma-error" class="gray badge outline" style="opacity: 0"></span>
        </span>

        {% if user.first_name or user.last_name %}
            <p>{{ user.first_name }} {{ user.last_name }}</p>
        {% endif %}

        {% if show_email and visible_email %}
            <p>{{ visible_email }}</p>
        {% endif %}

        {% if user.profile.location %}
            <p>{% blocktrans trimmed with location=user.profile.location %}From {{ location }}{% endblocktrans %}</p>
        {% endif %}

        {% if user.profile.birthday %}
            <p>{% blocktrans trimmed with birthday=user.profile.birthday %}Birthday at {{ birthday }}{% endblocktrans %}</p>
        {% endif %}

        {% if user.profile.about.html_force %}
            {% if user.first_name or user.last_name or user.profile.location or user.profile.birthday %}
                <hr>
            {% endif %}
            {{ user.profile.about.html_force|safe }}
            {% if editable or self_profile %}
                <hr>
            {% endif %}
        {% endif %}

        {% if editable or self_profile %}
            <p>
                {% if editable %}
                    <a href="{% url 'edit_profile' username=user.username %}">{% trans "Edit profile" %}</a>
                {% endif %}
                {% if editable and self_profile %}
                    &bull;
                {% endif %}
                {% if self_profile %}
                    <a href="{% url 'password_change' %}">{% trans "Change password" %}</a>
                {% endif %}
            </p>
        {% endif %}

        <hr>

        <p>{% trans "No membership" %}</p>

        <hr>

    </div>
{% endblock %}

{% block extra_scripts %}
    <script>

        function vote(vote) {
            d3.text('{% url "vote_user" username=user.username %}?vote=' + vote,
                    function (error, data) {
                        var score = parseInt(data);

                        if (isFinite(score)) {
                            d3.select('#karma-score').text(score);
                            d3.select('#karma-upvote-button')
                                    .classed('outline', vote != 1);
                            d3.select('#karma-downvote-button')
                                    .classed('outline', vote != -1);
                            d3.selectAll('.karma-color')
                                    .classed('gray', score < 10 && score > -10)
                                    .classed('green', score >= 10)
                                    .classed('orange', score <= -10);
                        } else {
                            d3.select('#karma-error').text(data)
                                    .interrupt()
                                    .style('opacity', 1)
                                    .transition()
                                    .duration(3000)
                                    .style('opacity', 0);
                        }
                    }
            )
        }

        d3.select('#karma-upvote-button').on('click', function (e) {
            if (d3.select('#karma-upvote-button').classed('outline')) {
                vote(1);
            } else {
                vote(0);
            }
        });
        d3.select('#karma-downvote-button').on('click', function (e) {
            if (d3.select('#karma-downvote-button').classed('outline')) {
                vote(-1);
            } else {
                vote(0);
            }
        });
    </script>
{% endblock %}
